<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE widget SYSTEM "widget-news.dtd">
<widget icon="icons/widget-news.png" name="&name;" unique="true" xmlns="http://bar.yandex.ru/dev/gui" xmlns:f="http://bar.yandex.ru/dev/functional">
    <f:setting name="update-interval" scope="widget" default="24">
        <control type="textedit" label="&settings.label;" label-after="&settings.label_after;" value-type="int" min="0" max="1000"/>
    </f:setting>
    <f:variable name="update-id-preset" scope="instance"/>
    <f:variable name="update-id-news" scope="instance"/>
    <f:variable name="throbber-end-time" scope="instance"/>
    <f:data name="show-throbber">
        <f:not>
            <f:or>
                <f:is-empty>
                    <f:value-of name="update-id-preset"/>
                </f:is-empty>
                <f:is-empty>
                    <f:value-of name="update-id-news"/>
                </f:is-empty>
                <f:and>
                    <f:finished>
                        <f:value-of name="update-id-preset"/>
                    </f:finished>
                    <f:finished>
                        <f:value-of name="update-id-news"/>
                    </f:finished>
                    <f:time-arrived>
                        <f:value-of name="throbber-end-time"/>
                    </f:time-arrived>
                </f:and>
            </f:or>
        </f:not>
    </f:data>
    <f:data name="export_preset_req">
        <f:request>
            <f:param name="url">
                <f:value type="string">http://bar-widgets.yandex.ru/presets/rss/</f:value>
            </f:param>
            <f:param name="update">
                <f:mul>
                    <f:value-of name="update-interval"/>
                    <f:value type="number">60</f:value>
                    <f:value type="number">60</f:value>
                </f:mul>
            </f:param>
            <f:param name="expire">
                <f:value type="number">259200</f:value>
            </f:param>
        </f:request>
    </f:data>
    <f:data name="export_preset">
        <f:try>
            <f:content>
                <f:value-of name="export_preset_req"/>
            </f:content>
            <f:param name="...">
                <f:value type="empty"/>
            </f:param>
        </f:try>
    </f:data>
    <f:setting name="last_date_preset" scope="instance">
    </f:setting>
    <f:data name="current_date_preset">
        <f:try>
            <f:xpath>
                <f:value type="string">string(/rss/channel/lastBuildDate)</f:value>
                <f:value-of name="export_preset"/>
            </f:xpath>
            <f:param name="...">
                <f:value type="empty"/>
            </f:param>
        </f:try>
    </f:data>
    <f:data name="export_news_req">
        <f:request>
            <f:param name="url">
                <f:value type="string">http://bar-widgets.yandex.ru/news/rss/latest/</f:value>
            </f:param>
            <f:param name="update">
                <f:mul>
                    <f:value-of name="update-interval"/>
                    <f:value type="number">60</f:value>
                    <f:value type="number">60</f:value>
                </f:mul>
            </f:param>
            <f:param name="expire">
                <f:value type="number">259200</f:value>
            </f:param>
        </f:request>
    </f:data>
    <f:data name="export_news">
        <f:try>
            <f:content>
                <f:value-of name="export_news_req"/>
            </f:content>
            <f:param name="...">
                <f:value type="empty"/>
            </f:param>
        </f:try>
    </f:data>
    <f:setting name="last_date_news" scope="instance">
    </f:setting>
    <f:data name="current_date_news">
        <f:try>
            <f:xpath>
                <f:value type="string">string(/rss/channel/lastBuildDate)</f:value>
                <f:value-of name="export_news"/>
            </f:xpath>
            <f:param name="...">
                <f:value type="empty"/>
            </f:param>
        </f:try>
    </f:data>
    <f:data name="have_data_preset">
        <f:not>
            <f:is-empty>
                <f:value-of name="export_preset"/>
            </f:is-empty>
        </f:not>
    </f:data>
    <f:data name="have_data_news">
        <f:not>
            <f:is-empty>
                <f:value-of name="export_news"/>
            </f:is-empty>
        </f:not>
    </f:data>
    <f:data name="test1">
        <f:if>
            <f:value-of name="have_data_preset"/>
            <f:not>
                <f:equal>
                    <f:value-of name="last_date_preset"/>
                    <f:value-of name="current_date_preset"/>
                </f:equal>
            </f:not>
            <f:value type="bool">false</f:value>
        </f:if>
    </f:data>
    <f:data name="test2">
        <f:if>
            <f:value-of name="have_data_news"/>
            <f:not>
                <f:equal>
                    <f:value-of name="last_date_news"/>
                    <f:value-of name="current_date_news"/>
                </f:equal>
            </f:not>
            <f:value type="bool">false</f:value>
        </f:if>
    </f:data>
    <f:data name="show_active">
        <f:or>
            <f:value-of name="test1"/>
            <f:value-of name="test2"/>
        </f:or>
    </f:data>
    <button>
        <icon>
            <f:if>
                <f:value-of name="show-throbber"/>
                <f:value type="string">xb://toolkit/images/throbber.gif</f:value>
                <f:if>
                    <f:value-of name="show_active"/>
                    <f:value type="string">icons/widget-news-active.gif</f:value>
                    <f:value type="string">icons/widget-news.png</f:value>
                </f:if>
            </f:if>
        </icon>
        <url action="5100">http://bar-widgets.yandex.ru/</url>
        <f:optional>
            <f:or>
                <f:value-of name="have_data_preset"/>
                <f:value-of name="have_data_news"/>
            </f:or>
            <tooltip>&tooltip.good;</tooltip>
        </f:optional>
        <f:optional>
            <f:and>
                <f:not>
                    <f:value-of name="have_data_preset"/>
                </f:not>
                <f:not>
                    <f:value-of name="have_data_news"/>
                </f:not>
            </f:and>
            <tooltip>
                <grid>
                    <row>
                        <cell>&tooltip.bad1;</cell>
                    </row>
                    <row>
                        <cell>&tooltip.bad2;</cell>
                    </row>
                </grid>
            </tooltip>
        </f:optional>
        <menu>
            <action>
                <f:assign name="last_date_preset">
                    <f:if>
                        <f:value-of name="have_data_preset"/>
                        <f:value-of name="current_date_preset"/>
                        <f:value-of name="last_date_preset"/>
                    </f:if>
                </f:assign>
                <f:assign name="last_date_news">
                    <f:if>
                        <f:value-of name="have_data_news"/>
                        <f:value-of name="current_date_news"/>
                        <f:value-of name="last_date_news"/>
                    </f:if>
                </f:assign>
            </action>
            <menuitem>
                <text>&refresh;</text>
                <action>
                    <f:assign name="update-id-preset">
                        <f:update>
                            <f:value-of name="export_preset_req"/>
                        </f:update>
                    </f:assign>
                    <f:assign name="update-id-news">
                        <f:update>
                            <f:value-of name="export_news_req"/>
                        </f:update>
                    </f:assign>
                    <f:assign name="throbber-end-time">
                        <f:add>
                            <f:timestamp/>
                            <f:value type="number">3</f:value>
                        </f:add>
                    </f:assign>
                </action>
            </menuitem>
            <separator/>
            <menuitem>
                <text>&goto;</text>
                <url action="5100">http://bar-widgets.yandex.ru/?from=bar_rss</url>
            </menuitem>
            <f:optional>
                <f:value-of name="have_data_preset"/>
                <separator/>

                <f:xpath>
                    <f:value type="string">menu/*</f:value>
                    <f:xslt>
                        <f:value type="string">widget-preset.xsl</f:value>
                        <f:value-of name="export_preset"/>
                    </f:xslt>
                </f:xpath>
            </f:optional>
            <f:optional>
                <f:value-of name="have_data_news"/>
                <separator/>

                <f:xpath>
                    <f:value type="string">menu/*</f:value>
                    <f:xslt>
                        <f:value type="string">widget-news.xsl</f:value>
                        <f:value-of name="export_news"/>
                    </f:xslt>
                </f:xpath>
            </f:optional>
        </menu>
    </button>
</widget>
